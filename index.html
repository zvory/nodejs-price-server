<html>
    <title>
        Price Visualization
    </title>
    <body>
        <p><a href="http://github.com/zvory/price-visualization">GitHub source </a>
        <p><text style="color:green">Green</text> line is current price. </p>
        <p><text style="color:magenta">Magenta</text> line is 3 second moving average </p>
        <canvas id="mycanvas" width="800" height="300"></canvas>
        <ul id="pageViews"></ul>
        <script src="https://cdn.socket.io/socket.io-1.4.3.js"></script>
        <script src="smoothie.js"></script>
        <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"> </script> 

        <script>

var socket = io.connect('http://csclub.uwaterloo.ca:9091');
socket.on('connect', function () {
    socket.on('price', function (msg) {
        writeGraphs (Number(msg));
    });
});


function computeThirtyDayAvg (arr){
    return arr.reduce(function (a, b) {
        return a + b;
    }) / arr.length;
}

function myYRangeFunction (range) {
    var min = range.min - 5;
    var max = range.max + 5;
    return {min: min, max: max};
}


var lastThirty = [];
var smoothie = new SmoothieChart({yRangeFunction: myYRangeFunction, millisPerPixel:100, timestampFormatter:SmoothieChart.timeFormatter, grid: { strokeStyle: 'rgb(125, 0, 0)', fillStyle: 'rgb(60, 0, 0)', lineWidth: 1, millisPerLine: 250, verticalSections: 6 } });
smoothie.streamTo(document.getElementById("mycanvas"), 1000);

var currentSeries = new TimeSeries();
var thirtySeries = new TimeSeries();

smoothie.addTimeSeries(currentSeries, { strokeStyle: 'rgb(0, 255, 0)', fillStyle: 'rgba(0, 255, 0, 0.4)', lineWidth: 3 });
smoothie.addTimeSeries(thirtySeries,
          { strokeStyle:'rgb(255, 0, 255)', fillStyle:'rgba(255, 0, 255, 0.3)', lineWidth:3 });

function writeGraphs (datapoint) {
    if (lastThirty.length > 60)
        lastThirty.shift(datapoint);
    
    lastThirty.push(datapoint);
    
    thirtySeries.append(new Date().getTime(), computeThirtyDayAvg(lastThirty));
    currentSeries.append(new Date().getTime(), datapoint); 


}




        </script>



    </body>
</html>
